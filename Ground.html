<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ground Floor — Registration → Event Navigation (Complete)</title>
<style>
:root{
  --bg:#eef4fb; --panel:#ffffff; --accent:#0b66d6; --muted:#516273; --path:#ff5252;
}
html,body{height:100%;margin:0;font-family:Inter,Arial,Roboto,sans-serif;background:var(--bg)}
header{display:flex;align-items:center;padding:10px;background:var(--panel);box-shadow:0 1px 4px rgba(0,0,0,0.06);position:sticky;top:0;z-index:20}
header h1{margin:0;font-size:16px}
#controls{margin-left:auto;display:flex;gap:8px;align-items:center}
#app{display:flex;gap:12px;padding:12px;min-height:calc(100vh - 64px)}
#left{flex:1}
#map-wrap{background:var(--panel);padding:12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
#sidebar{width:380px;max-width:42%;display:flex;flex-direction:column;gap:12px}
.panel{background:var(--panel);padding:12px;border-radius:10px}
.muted{color:var(--muted);font-size:13px}
svg{width:100%;height:78vh;touch-action:none;display:block}
.room{fill:#dff4ff;stroke:#1a4e7a;stroke-width:1.5;cursor:pointer}
.room.highlight{stroke:#ff6b6b;stroke-width:3;fill:#fff6f6}
.corridor-line{stroke:#bcd7ee;stroke-width:22;fill:none;stroke-linecap:round}
#road{stroke:#666;stroke-width:28;stroke-linecap:round}
#regGate{fill:#ffd83a;stroke:#8b6b00;stroke-width:2}
#route{fill:none;stroke:var(--path);stroke-width:12;stroke-linecap:round;stroke-linejoin:round}
#routeOverlay{fill:none;stroke:transparent;stroke-width:12}
.info-row{display:flex;justify-content:space-between;gap:12px;align-items:center}
#progressBar{height:10px;background:#eee;border-radius:8px;overflow:hidden;margin-top:6px}
#progressFill{height:100%;width:0;background:var(--accent);transition:width 0.18s linear}
button,input,select{padding:8px;border-radius:8px;border:1px solid #d6dae0;background:#fff;font-size:14px}
button.primary{background:var(--accent);color:#fff;border:none}
footer{padding:8px 12px;text-align:center;color:var(--muted)}
@media (max-width:900px){#app{flex-direction:column}#sidebar{width:100%}}
</style>
</head>
<body>
<header>
  <h1>Symposium Map — Ground Floor (Complete)</h1>
  <div id="controls">
    <input id="searchBox" placeholder="Search: LT01, LIB, PRIN, COE…" />
    <button id="searchBtn">Search</button>
  </div>
</header>

<div id="app">
  <div id="left">
    <div id="map-wrap" class="panel" aria-label="Map area">
      <svg id="svg" viewBox="0 0 1000 1200" role="img" aria-label="Ground floor map">
        <title>Ground floor plan</title>

        <!-- STRAIGHT ROAD bottom center -> gate -> registration -->
        <line id="road" x1="500" y1="1200" x2="500" y2="1020" />

        <!-- Registration Gate (start) -->
        <circle id="regGate" cx="500" cy="1015" r="22" />
        <text x="500" y="1046" font-size="18" text-anchor="middle" fill="#102030">Registration</text>

        <!-- Outer corridor ring -->
        <polyline id="corridor" class="corridor-line"
          points="160,180 840,180 840,820 160,820 160,180" />

        <!-- CENTRAL COURTYARD (non-walkable) -->
        <rect x="300" y="260" width="400" height="380" fill="#fbfdff" stroke="#eef3fb" />
        <text x="500" y="450" font-size="18" text-anchor="middle" fill="#707885">Central Courtyard</text>

        <!-- TOP (north) labs and restroom -->
        <rect id="PH1" class="room" x="200" y="80" width="170" height="80"/>
        <text x="280" y="130" font-size="12" text-anchor="middle">Physics Class</text>

        <rect id="PH2" class="room" x="400" y="80" width="200" height="80"/>
        <text x="480" y="130" font-size="12" text-anchor="middle">Lab-2</text>

        <rect id="COE" class="room" x="630" y="80" width="170" height="80"/>
        <text x="710" y="130" font-size="12" text-anchor="middle">COE</text>

        <!-- RIGHT side: 5 LH rooms down the right corridor -->
        <rect id="LT01" class="room" x="860" y="245" width="80" height="90"/>
        <text x="900" y="300" font-size="11" text-anchor="middle">LH01</text>

        <rect id="LT02" class="room" x="860" y="345" width="80" height="90"/>
        <text x="900" y="400" font-size="11" text-anchor="middle">LH02</text>

        <rect id="LT03" class="room" x="860" y="445" width="80" height="90"/>
        <text x="900" y="500" font-size="11" text-anchor="middle">LH03</text>

        <rect id="LT04" class="room" x="860" y="545" width="80" height="90"/>
        <text x="900" y="600" font-size="11" text-anchor="middle">LH04</text>

        <rect id="LT05" class="room" x="860" y="645" width="80" height="90"/>
        <text x="900" y="700" font-size="11" text-anchor="middle">LH05</text>

        <!-- BOTTOM side (facing gate) : Principal on left, gap/admin in middle, CDC on right -->
        <rect id="PRIN" class="room" x="180" y="840" width="220" height="80"/>
        <text x="290" y="880" font-size="12" text-anchor="middle">Principal Office (faces gate)</text>


        <rect id="CDC" class="room" x="600" y="840" width="220" height="80"/>
        <text x="710" y="880" font-size="12" text-anchor="middle">Career Dev Cell (CDC)</text>
        

        <!-- WEST side: CH, Library, etc. (Principal near exit on left per your "B" choice) -->
        <rect id="CH" class="room" x="40" y="220" width="100" height="100"/>
        <text x="80" y="270" font-size="12" text-anchor="middle">CH Room</text>

        <rect id="LIB" class="room" x="40" y="350" width="100" height="260"/>
        <text x="80" y="500" font-size="12" text-anchor="middle">Library</text>

        <rect id="WEST_OFF" class="room" x="40" y="640" width="100" height="120"/>
        <text x="80" y="695" font-size="12" text-anchor="middle">Office</text>
        

        <!-- FOUR corner stairs -->
        <rect id="stair-NW" x="90" y="80" width="50" height="80" fill="#e8f2ff" stroke="#7aa6ff"/>
        <text x="115" y="120" font-size="10" text-anchor="middle">Stair</text>

        <rect id="stair-NE" x="860" y="80" width="50" height="80" fill="#e8f2ff" stroke="#7aa6ff"/>
        <text x="885" y="120" font-size="10" text-anchor="middle">Stair</text>

        <rect class="room" x="860" y="200" width="40" height="40"/>
        <text x="880" y="220" font-size="11" text-anchor="middle">water</text>

        <rect id="stair-SW" x="-10" y="850" width="50" height="80" fill="#e8f2ff" stroke="#7aa6ff"/>
        <text x="15" y="890" font-size="10" text-anchor="middle">Stair</text>

        <rect class="room" x="-25" y="790" width="40" height="40"/>
        <text x="-5" y="810" font-size="11" text-anchor="middle">water</text>

        <rect class="room" x="80" y="775" width="50" height="40"/>
        <text x="105" y="800" font-size="11" text-anchor="middle">filt</text>

        <rect id="stair-SE" x="900" y="850" width="50" height="80" fill="#e8f2ff" stroke="#7aa6ff"/>
        <text x="925" y="890" font-size="10" text-anchor="middle">Stair</text>

        <rect class="room" x="860" y="765" width="40" height="40"/>
        <text x="880" y="790" font-size="11" text-anchor="middle">water</text>

        <!--outside-->

        <rect class="room" x="-180" y="230" width="100" height="350"/>
        <text x="-140" y="430" font-size="11" text-anchor="middle">workshop</text>

        <rect class="room" x="-580" y="530" width="320" height="250"/>
        <text x="-500" y="650" font-size="11" text-anchor="middle">auditorium</text>

        <rect class="room" x="-580" y="230" width="320" height="150"/>
        <text x="-500" y="300" font-size="11" text-anchor="middle">Cafeterita</text>

        <rect id="stair-SE" x="-15" y="500" width="50" height="80" fill="#e8f2ff" stroke="#7aa6ff"/>
        <text x="8" y="54+
        
        0" font-size="10" text-anchor="middle">canteen</text>

        <!-- Top-right restroom near stair -->
        <rect id="REST_TOP" class="room" x="940" y="100" width="80" height="60" style="fill:#ffefef;stroke:#e04a4a"/>
        <text x="980" y="135" font-size="11" text-anchor="middle">Restroom</text>


        <!-- dynamic route & overlay (drawn by JS) -->
        <polyline id="route" points="" />
        <polyline id="routeOverlay" points="" />
      </svg>
    </div>
  </div>

  <aside id="sidebar" class="panel">
    <div class="panel">
      <div class="muted">Start (fixed)</div>
      <div style="font-weight:600;margin:6px 0">Registration Gate (bottom-center)</div>

      <div class="muted" style="margin-top:8px">Destination</div>
      <select id="destSelect" style="width:100%;margin-top:6px">
        <option value="">-- choose destination --</option>
        <option value="CDC">CDC (Career Dev)</option>
        <option value="PRIN">Principal Office</option>
        <option value="ADMIN">Admin (gap)</option>
        <option value="LT01">LH01 (Right)</option>
        <option value="LT02">LH02 (Right)</option>
        <option value="LT03">LH03 (Right)</option>
        <option value="LT04">LH04 (Right)</option>
        <option value="LT05">LH05 (Right)</option>
        <option value="PH2">Lab-2 (Top)</option>
        <option value="PH1">Physics Class (Top-left)</option>
        <option value="COE">COE (Top-right)</option>
        <option value="REST_TOP">Restroom (Top-right)</option>
        <option value="CH">CH Room (Left)</option>
        <option value="LIB">Library (Left)</option>
      </select>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="startBtn" class="primary">Start Navigation</button>
        <button id="stopBtn">Stop</button>
      </div>

      <div style="margin-top:12px" class="muted">Calibration & fallback</div>
      <label class="small">Avg step length (meters)</label>
      <input id="stepLen" type="number" step="0.01" value="0.75" style="width:100%;margin-top:6px"/>

      <div style="display:flex;gap:6px;margin-top:10px">
        <button id="manualStep">Manual Step</button>
        <button id="resetProgress">Reset</button>
      </div>
    </div>

    <div class="panel">
      <div class="muted">Navigation status</div>
      <div style="margin-top:8px" class="info-row"><div>Steps</div><div id="steps">0</div></div>
      <div class="info-row"><div>Distance traveled</div><div id="distTraveled">0.0 m</div></div>
      <div class="info-row"><div>Remaining</div><div id="distRemaining">0.0 m</div></div>
      <div id="progressBar"><div id="progressFill"></div></div>
    </div>

    <div class="panel">
      <div class="muted">Instruction (voice + text)</div>
      <div id="instr" style="margin-top:8px;font-weight:700">No active route</div>
    </div>
  </aside>
</div>

<footer>Open in Chrome (Android) for best sensor support. Grant motion permission when prompted.</footer>

<script>
/* -----------------------------------------
   Map data (pixel coordinates) and graph
   - This graph is a ring around the courtyard.
   - REG (registration) connects to S1 (south-center).
-----------------------------------------*/
const REG = {x:500,y:1015}; // registration gate start
const nodes = {
  // Top row (left-to-right)
  N_W:{x:180,y:160}, N1:{x:300,y:160}, N2:{x:450,y:160}, N3:{x:610,y:160}, N_E:{x:760,y:160},
  // Right side top-to-bottom
  E1:{x:860,y:260}, E2:{x:860,y:360}, E3:{x:860,y:460}, E4:{x:860,y:560},
  // Bottom row right-to-left
  S_E:{x:760,y:820}, S2:{x:600,y:820}, S1:{x:420,y:820}, S_W:{x:220,y:820},
  // Left side bottom-to-top
  W_S:{x:160,y:600}, W1:{x:160,y:460}, W2:{x:160,y:320}
};

/* adjacency ring + REG connection */
const graph = {
  'REG':['S1'],
  'N_W':['N1'],'N1':['N_W','N2'],'N2':['N1','N3'],'N3':['N2','N_E'],'N_E':['N3','E1'],
  'E1':['N_E','E2'],'E2':['E1','E3'],'E3':['E2','E4'],'E4':['E3','S_E'],
  'S_E':['E4','S2'],'S2':['S_E','S1'],'S1':['S2','S_W','REG'],'S_W':['S1','W_S'],
  'W_S':['S_W','W1'],'W1':['W_S','W2'],'W2':['W1','N_W']
};

/* POI -> corridor node mapping */
const POI_NODE = {
  'CDC':'S2', 'PRIN':'S_W', 'ADMIN':'S1',
  'LT01':'E1','LT02':'E2','LT03':'E3','LT04':'E4','LT05':'S_E',
  'PH2':'N2','PH1':'N1','COE':'N3','REST_TOP':'N_E',
  'CH':'W2','LIB':'W1'
};

/* DOM refs */
const route = document.getElementById('route');
const routeOverlay = document.getElementById('routeOverlay');
const destSelect = document.getElementById('destSelect');
const instrEl = document.getElementById('instr');
const stepsEl = document.getElementById('steps');
const distTrEl = document.getElementById('distTraveled');
const distRemEl = document.getElementById('distRemaining');
const progressFill = document.getElementById('progressFill');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const manualStepBtn = document.getElementById('manualStep');
const resetBtn = document.getElementById('resetProgress');
const searchBox = document.getElementById('searchBox');
const searchBtn = document.getElementById('searchBtn');

/* State */
let currentRoute = [], routePoints = '', routePixelsTotal = 0, traveledPixels = 0;
let pixelsPerMeter = 55; // relative pixel-to-meter (adjust if needed)
let avgStepMeters = parseFloat(document.getElementById('stepLen').value) || 0.75;
let lastSpokenIndex = 0;
let stepCount = 0;
let lastPeak = 0;
const minStepInterval = 300;

/* helpers */
function nodePos(k){ return (k==='REG')?REG:nodes[k]; }
function findPath(start, end){
  if(start===end) return [start];
  const q=[start], prev={[start]:null};
  while(q.length){
    const cur = q.shift();
    const neighbors = graph[cur] || [];
    for(const nb of neighbors){
      if(prev[nb] !== undefined) continue;
      prev[nb] = cur; q.push(nb);
      if(nb === end){
        const out = [nb]; let p = cur;
        while(p !== null){ out.unshift(p); p = prev[p]; }
        return out;
      }
    }
  }
  return null;
}
function pathToPoints(seq){ return seq.map(k=>{ const p = (k==='REG')?REG:nodes[k]; return `${p.x} ${p.y}`; }).join(' '); }
function polylineLength(points){ routeOverlay.setAttribute('points', points); try{return routeOverlay.getTotalLength();}catch(e){return 0;} }

/* draw route from REG to destination POI */
function setRouteTo(destKey){
  if(!POI_NODE[destKey]){ alert('Destination mapping missing'); return false; }
  const nodeKey = POI_NODE[destKey];
  const seq = findPath('REG', nodeKey);
  if(!seq){ alert('No corridor path'); return false; }
  currentRoute = seq.slice();
  routePoints = pathToPoints(currentRoute);
  route.setAttribute('points', routePoints);
  routeOverlay.setAttribute('points', routePoints);
  routePixelsTotal = polylineLength(routePoints);
  traveledPixels = 0; stepCount = 0; lastSpokenIndex = 0;
  updateUI(); setRouteDash(0);
  const inst = makeInstructions(currentRoute);
  instrEl.textContent = inst[0]?.text || 'Follow the route';
  speak(inst[0]?.speech || inst[0]?.text || 'Follow the route');
  return true;
}
/* stroke-dash shrink */
function setRouteDash(travelPx){
  try{
    const total = routeOverlay.getTotalLength();
    route.style.strokeDasharray = total;
    route.style.strokeDashoffset = Math.max(0, total - travelPx);
  }catch(e){}
}
/* instructions builder */
function makeInstructions(seq){
  const out=[];
  if(!seq||seq.length<2) return out;
  out.push({text:'Start at Registration', speech:'Start at registration.'});
  for(let i=1;i<seq.length;i++){
    const a = nodePos(seq[i-1]), b=nodePos(seq[i]);
    const dx = b.x - a.x, dy = b.y - a.y;
    const dist = Math.hypot(dx,dy);
    let dir = 'proceed';
    if(Math.abs(dx) > Math.abs(dy)) dir = dx > 0 ? 'proceed east' : 'proceed west';
    else dir = dy > 0 ? 'proceed south' : 'proceed north';
    const meters = Math.round((dist / pixelsPerMeter)*100)/100;
    out.push({text:`${dir} for ${meters} m`, speech:`${dir} for ${meters} meters.`});
  }
  out.push({text:'You arrived at destination', speech:'You have arrived at your destination.'});
  return out;
}
/* UI update */
function updateUI(){
  stepsEl.textContent = stepCount;
  distTrEl.textContent = (stepCount * avgStepMeters).toFixed(2) + ' m';
  const remain = Math.max(0, (routePixelsTotal - traveledPixels)/pixelsPerMeter).toFixed(2);
  distRemEl.textContent = remain + ' m';
  const pct = routePixelsTotal ? Math.min(100, Math.round((traveledPixels/routePixelsTotal)*100)) : 0;
  progressFill.style.width = pct + '%';
}
/* motion handling (peak detection) */
function motionHandler(ev){
  const acc = ev.accelerationIncludingGravity || ev.acceleration || {x:0,y:0,z:0};
  const mag = Math.sqrt((acc.x||0)**2 + (acc.y||0)**2 + (acc.z||0)**2);
  const g = 9.81;
  const val = Math.abs(mag - g);
  if(val > 1.1){
    const now = Date.now();
    if(now - lastPeak > minStepInterval){
      lastPeak = now;
      stepCount++;
      const px = (avgStepMeters || 0.75) * pixelsPerMeter;
      traveledPixels += px;
      setRouteDash(traveledPixels);
      updateUI();
      checkAndSpeak();
      if(traveledPixels >= routePixelsTotal) arrive();
    }
  }
}
function arrive(){
  instrEl.textContent = 'You have arrived';
  speak('You have arrived at your destination');
  stopMotion();
}
function speak(text){
  if(!text) return;
  try{
    if('speechSynthesis' in window){
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }
  }catch(e){}
}
async function startMotion(){
  avgStepMeters = parseFloat(document.getElementById('stepLen').value) || 0.75;
  if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
    try{
      const res = await DeviceMotionEvent.requestPermission();
      if(res === 'granted'){ window.addEventListener('devicemotion', motionHandler, {passive:true}); }
      else { alert('Motion permission denied. Use Manual Step.'); }
    }catch(e){
      alert('Motion permission error. Use manual fallback.');
    }
  } else {
    window.addEventListener('devicemotion', motionHandler, {passive:true});
  }
}
function stopMotion(){ window.removeEventListener('devicemotion', motionHandler); }

/* speak at segment thresholds */
function checkAndSpeak(){
  if(!currentRoute || currentRoute.length < 2) return;
  let cum = 0; const thresholds = [];
  for(let i=1;i<currentRoute.length;i++){
    const a = nodePos(currentRoute[i-1]), b=nodePos(currentRoute[i]);
    const d = Math.hypot(a.x-b.x, a.y-b.y); cum += d; thresholds.push(cum);
  }
  for(let i=0;i<thresholds.length;i++){
    if(traveledPixels >= thresholds[i] && lastSpokenIndex < i+1){
      const inst = makeInstructions(currentRoute);
      const s = inst[i+1] ? inst[i+1].speech : '';
      speak(s);
      lastSpokenIndex = i+1;
    }
  }
}

/* UI wiring */
startBtn.addEventListener('click', async ()=>{
  const dest = destSelect.value;
  if(!dest){ alert('Choose destination'); return; }
  const ok = setRouteTo(dest);
  if(!ok) return;
  instrEl.textContent = 'Navigation started';
  await startMotion();
});
stopBtn.addEventListener('click', ()=>{ stopMotion(); instrEl.textContent = 'Navigation stopped'; });
manualStepBtn.addEventListener('click', ()=>{ stepCount++; const px = (avgStepMeters || 0.75) * pixelsPerMeter; traveledPixels += px; setRouteDash(traveledPixels); updateUI(); checkAndSpeak(); if(traveledPixels >= routePixelsTotal) arrive(); });
resetBtn.addEventListener('click', ()=>{ traveledPixels = 0; stepCount = 0; setRouteDash(0); updateUI(); instrEl.textContent = 'Progress reset'; });

/* room click sets destination */
document.querySelectorAll('.room').forEach(el=>{
  el.addEventListener('click', ()=>{ const id = el.id; if(POI_NODE[id]){ destSelect.value = id; el.classList.add('highlight'); setTimeout(()=>el.classList.remove('highlight'),1200); } });
});

/* search */
searchBtn.addEventListener('click', ()=>{ const q = searchBox.value.trim(); if(!q) return; const el = document.getElementById(q.toUpperCase()); if(el){ el.classList.add('highlight'); setTimeout(()=>el.classList.remove('highlight'),1200); destSelect.value = q.toUpperCase(); } else alert('Not found: ' + q); });

/* set route helper */
function setRouteTo(destKey){
  if(!POI_NODE[destKey]){ alert('Unknown destination'); return false; }
  const nodeKey = POI_NODE[destKey];
  const seq = findPath('REG', nodeKey);
  if(!seq){ alert('No corridor path'); return false; }
  currentRoute = seq.slice();
  routePoints = pathToPoints(currentRoute);
  route.setAttribute('points', routePoints);
  routeOverlay.setAttribute('points', routePoints);
  routePixelsTotal = polylineLength(routePoints);
  traveledPixels = 0; stepCount = 0; lastSpokenIndex = 0;
  updateUI(); setRouteDash(0);
  const inst = makeInstructions(currentRoute);
  instrEl.textContent = inst[0]?.text || 'Follow the route';
  speak(inst[0]?.speech || inst[0]?.text || 'Follow the route');
  return true;
}

/* helpers for polyline length / points */
function polylineLength(pts){ routeOverlay.setAttribute('points', pts); try{return routeOverlay.getTotalLength();}catch(e){return 0;} }

/* Expose navigateTo for WebView / QR flows */
window.navigateTo = function(name){
  if(!name) return;
  const n = name.trim().toUpperCase();
  if(POI_NODE[n]){ destSelect.value = n; setRouteTo(n); startMotion().catch(()=>{}); }
  else alert('Unknown destination: ' + name);
};

/* initial UI */
setRouteDash(0);
updateUI();

</script>
</body>
</html>
